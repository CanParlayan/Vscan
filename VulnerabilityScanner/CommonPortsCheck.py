import subprocess
import shlex
from urllib.parse import urlparse


class CommonPortsCheck:

    def __init__(self, quiet):
        # Constructor to initialize the object with the 'quiet' attribute
        self.quiet = quiet

    def scan_ports(self, url, report):
        """
        Scan common ports of the provided URL using nmap.
        
        Args:
            url (str): URL of the site to be scanned.
            report (Report): Report file object.
        """
        if not self.quiet:
            print("[*] Scanning common ports using nmap")

        # Extract hostname from the provided URL
        parsed_url = urlparse(url)
        host = parsed_url.hostname

        # Construct nmap command to scan common ports and prepare for execution
        nmap_command = f"nmap -F {host}"
        safe_command = shlex.split(nmap_command)

        try:
            # Execute the nmap command and capture the output
            result = subprocess.run(safe_command, capture_output=True, text=True, check=True)

            # Write the scanning header to the report
            report.write_to_report("\n [*****] Scanning common ports with nmap [*****] \n \n")

            # Write nmap output to the report
            report.write_to_report(result.stdout)
        except subprocess.CalledProcessError as e:
            # Handle errors that may occur during nmap execution
            print(f"An error occurred while scanning ports: {e}")
        except FileNotFoundError:
            # Handle the case where nmap is not installed or not found in the PATH
            print("nmap is not installed or not found in PATH.")

        if not self.quiet:
            print("[*] Common ports have been scanned!")
