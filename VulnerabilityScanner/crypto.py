import re
import subprocess
from urllib.parse import urlparse

def testConnection(url, report):
    try:

        parsedURL = urlparse(url)
        hostname = parsedURL.hostname

        command = f"nmap --script ssl-cert,ssl-enum-ciphers -p 443 {hostname}"
        result = subprocess.run(command, shell=True, capture_output=True, text=True)

        output_lines = result.stdout.split('\n')
        ciphers = []
        ssl_cert_info = []

        for line in output_lines:
            match = re.match(r"\| +([A-Za-z0-9_]+) \(([\w\s]+)\) - ([A-F])", line)
            if match:
                cipher_name = match.group(1)
                key_type = match.group(2)
                strength = match.group(3)
                ciphers.append((cipher_name, key_type, strength))
            elif "ssl-cert:" in line or "Subject:" in line or "Public Key type:" in line \
                    or "Public Key bits:" in line or "Signature Algorithm:" in line \
                    or "Not valid before:" in line or "Not valid after:" in line:
                ssl_cert_info.append(line.strip())

        report.write_to_crypto(ciphers, ssl_cert_info)

    except Exception as e:
        print(f"Error: {e}")
